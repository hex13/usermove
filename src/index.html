<div style="height:300px;border:1px solid black"></div>
<div id="text" style="height:40; padding: 5px">abc</div>
<div id="text2" style="height:40; padding: 20px">abc</div>
<canvas id="app" width="1000" height="1000"></canvas>
<script>
    window.mode = 'draw';
    const ids = [];
    const label = document.getElementById('text');
    const label2 = document.getElementById('text2');
    function updateLabel(ids) {
        label.innerText = Object.entries(ids).map(entry => entry[0] + "(" + entry[1] + ")").join(', ');
    }
    function interpolate(from, to, cb) {
        const distX = to.x - from.x;
        const distY = to.y - from.y;
        const dist = Math.hypot(distX, distY);
        const stepX = distX / dist;
        const stepY = distY / dist; 
        let x = from.x;
        let y = from.y;
        for (let a = 0; a < dist; a += 1) {
            cb({x, y});
            x += stepX;
            y += stepY;
        }
    }

    class Controller {
        constructor(el, opts = {}) {
            this.el = el;
            this.start = {x: 0, y: 0};
            this.last = null;
            this.handlers = {};
            this.opts = opts;
            this.pointers = {};
        }
        init() {
            this.on('touchmove', e => {
                e.domEvent.preventDefault();
            });
            this.on('pointerdown', e => {
                this.pointers[e.domEvent.pointerId] = e;
                this.down = true;
                this.start = e;
                this.last = e;
                updateLabel(this.pointers);
            });
            this.on('pointermove', e => {
                if (!this.down) return;
                this.pointers[e.domEvent.pointerId] = e;
                const pointerCount = Object.keys(this.pointers).length;
                if (pointerCount == 1) {
                    interpolate(this.last, e, interpolated => {
                        const delta = {
                            x: interpolated.x - this.start.x,
                            y: interpolated.y - this.start.y,
                        };
                        delta.angle = Math.atan2(delta.y, delta.x);
                        delta.distance = Math.hypot(delta.x, delta.y);
                        this.dispatch({ ...interpolated, type: 'usermove:drag', start: {...this.start}, delta, isPrimary: e.isPrimary});
                    });
                    this.last = e;
                } else if (pointerCount == 2) {
                    const [a, b] = Object.values(this.pointers);
                    const distance = a.x + ", " + a.y + "; " + b.x + ", " + b.y + " DIST: " + Math.hypot(a.x - b.x, a.y - b.y);
                    label2.innerText = distance;
                }

            });
            this.on('pointerup', e => {
                this.down = false;
                delete this.pointers[e.domEvent.pointerId];
                updateLabel(this.pointers);
            });
        }
        dispatch(e) {
            if (Object.hasOwn(this.handlers, e.type)) {
                this.handlers[e.type].forEach(handler => handler(e));
            }
        }
        mapEvent(e) {
            const boundingRect = this.el.getBoundingClientRect();
            const x = e.clientX - boundingRect.x;
            const y = e.clientY - boundingRect.y;
            const transformedEvent = { type: e.type, x, y, down: this.down, domEvent: e, start: { ...this.start}, isPrimary: e.isPrimary };
            if (this.opts.transformEvent) this.opts.transformEvent(transformedEvent);
            return transformedEvent;
        }
        on(eventName, handler) {
            if (!this.handlers[eventName]) {
                this.handlers[eventName] = [];
                this.el.addEventListener(eventName, e => {
                    this.dispatch(this.mapEvent(e));
                });
            }
            this.handlers[eventName].push(handler);
        }

    }

    const canvas = document.getElementById('app');
    const ctx = canvas.getContext('2d');

    function render() {
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    render();

    const controller = new Controller(canvas, {
        transformEvent(e) {
            const factor = 1;
            e.x = Math.floor(e.x / factor) * factor;
            e.y = Math.floor(e.y / factor) * factor;
        }
    });

    controller.init();

    controller.on('pointerdown', e => {
        if (!e.isPrimary) return;
        ctx.fillStyle = 'red';
        ctx.fillRect(e.x, e.y, 6, 6);
    });
    controller.on('click', e => {
        console.log("click 2")
    });


    controller.on('usermove:drag', e => {
        if (!e.isPrimary) return;

        if (window.mode == 'draw') {
            ctx.fillStyle = 'yellow';
            ctx.fillRect(e.x, e.y, 2, 2);
        } else if (window.mode == 'move') {
            const delta = e.delta;
            ctx.fillStyle = 'red';
            ctx.fillRect(e.start.x + Math.cos(delta.angle) * delta.distance, e.start.y + Math.sin(delta.angle) * delta.distance, 2, 2);


        }
    });

</script>